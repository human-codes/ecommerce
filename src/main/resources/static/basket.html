<!DOCTYPE
        html >
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <style>
        body {
            background-color: #f8f9fa;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            margin: 0;
            padding-top: 70px;
        }
        .cart-container {
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
        }
        .cart-item {
            display: flex;
            align-items: center;
            position: relative;
            border: 1px solid #28a745;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .cart-item img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
        }
        .cart-item .details {
            flex: 1;
            padding-left: 15px;
        }
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .quantity-controls button {
            border: 1px solid #28a745;
            background: white;
            color: #28a745;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
        }
        .delete-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #dc3545;
            font-size: 18px;
            cursor: pointer;
        }
        .checkout-container {
            padding-top: 20px;
        }
        #showtotalcost {
            text-align: left;
            margin-bottom: 20px;
        }
        .buttons-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
        }
        .checkout-button {
            background-color: whitesmoke;
            border: 2px solid #28a745;
            color: black;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 18px;
            cursor: pointer;
            transition: 0.3s;
        }
        .checkout-button:hover {
            background-color: #28a745;
            color: white;
        }
        .clear-cart-button {
            background: white;
            border: 2px solid red;
            color: black;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: 0.3s;
        }
        .clear-cart-button:hover {
            background-color: red;
            color: white;
        }
        .empty-cart {
            text-align: center;
            margin-top: 150px;
            color: #28a745;
        }
        .empty-cart img {
            width: 100px;
            margin-bottom: 10px;
        }
        .go-to-store-button {
            background-color: #ff5733;
            color: white;
        }
        .centered {
            display: block;
            margin: 20px auto 0;
        }
        .hidden {
            display: none;
        }

        .navbar .navbar-brand.active {
            font-weight: bolder;
            text-decoration: underline;
            color: #28a745 !important; /* Yashil rang */
        }

        .cart-icons a {
            font-size: 14px; /* Kichikroq shrift */
            color: #6c757d; /* Bootstrap-ning default kulrangi */
            text-decoration: none; /* Underline olib tashlash */
            display: flex;
            align-items: center;
            gap: 5px; /* Icon va matn orasidagi masofa */
            padding: 5px 8px; /* Ichki oraliq */
        }

        .profile {
            font-size: 19px; /* Kichikroq shrift */
            color: #6c757d; /* Bootstrap-ning default kulrangi */
            text-decoration: none; /* Underline olib tashlash */
            display: flex;
            align-items: center;
            gap: 5px; /* Icon va matn orasidagi masofa */
            padding: 5px 8px; /* Ichki oraliq */
            transition: color 0.3s, background 0.3s; /* Yoqimli animatsiya */
        }

        .profile:hover,
        .profile.active {
            color: #fff !important; /* Oq rangga o'tadi */
            background-color: #6c757d !important; /* Yashil fon */
        }

        .cart-icons a:hover {
            color: #198754; /* Yashil rangga o'tadi */
        }

        .cart-icons i {
            font-size: 16px; /* Iconlar biroz kichik */
        }

        .cart-badge {
            font-size: 12px; /* Savat belgisi soni kichikroq bo'lsin */
            background: red;
            color: white;
            border-radius: 50%;
            padding: 2px 5px;
            margin-left: 3px;
        }

        .footer {
            background-color: #12151c;
            color: white;
            padding: 40px 20px;
            margin-top: auto;
        }

        .containerjon {
            display: flex;
            justify-content: space-between;
            max-width: 1200px;
            margin: auto;
        }

        .footer-section {
            width: 30%;
        }

        .underline {
            width: 50px;
            height: 3px;
            background-color: #4caf50;
            margin-bottom: 10px;
        }

        .social-icons a {
            color: #aaa;
            font-size: 20px;
            margin-right: 10px;
            transition: 0.3s;
        }

        .social-icons a:hover {
            color: white;
        }

        ul {
            list-style: none;
            padding: 0;
        }

        ul li a {
            color: #aaa;
            text-decoration: none;
            display: block;
            margin-bottom: 8px;
            transition: 0.3s;
        }

        ul li a:hover {
            color: white;
        }

        .email-input {
            width: 100%;
            padding: 12px;
            background-color: #2a2e38;
            border: 1px solid #4caf50;
            border-radius: 10px;
            color: white;
            margin-bottom: 12px;
            font-size: 16px;
            outline: none;
            transition: 0.3s;
        }

        .email-input:focus {
            border-color: #43a047;
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.6);
        }

        .subscribe-btn {
            width: 100%;
            padding: 12px;
            background-color: #4caf50;
            color: white;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: 0.3s;
            border: none;
            font-weight: bold;
        }

        .subscribe-btn:hover {
            background-color: #43a047;
            box-shadow: 0 4px 10px rgba(76, 175, 80, 0.4);
            transform: translateY(-2px);
        }

        .social-icons a {
            font-size: 28px; /* Ikonkalarni kattalashtirish */
            color: #aaa;
            transition: 0.3s;
            margin: 27px;
        }

        .social-icons a:hover {
            color: white; /* Hover effekti */
        }

        /* Notification Styles */
        #notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .notification {
            display: flex;
            align-items: center;
            gap: 15px;
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 16px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transform: translateX(100%);
            animation: slideIn 0.5s forwards, fadeOut 0.5s 4.5s forwards;
            position: relative;
            overflow: hidden;
        }

        /* Like ikonkasi */
        .notification .icon {
            font-size: 22px;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px;
            border-radius: 50%;
        }

        /* Close tugmasi */
        .notification .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            position: absolute;
            right: 10px;
            top: 10px;
        }

        /* Animatsiyalar */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        /* Checkout Modal Styles */
        #checkoutModal .modal-content {
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        #checkoutModal .modal-header {
            background: linear-gradient(135deg, #4caf50, #2e7d32);
            color: white;
            border-bottom: none;
            padding: 1.25rem;
        }

        #checkoutModal .modal-title {
            font-weight: 600;
            font-size: 1.25rem;
        }

        #checkoutModal .modal-body {
            padding: 1.5rem;
        }

        #checkoutModal .form-label {
            font-weight: 500;
            color: #333;
        }

        #checkoutModal .form-control,
        #checkoutModal .input-group-text {
            border-radius: 8px;
            padding: 0.75rem 1rem;
            border: 1px solid #ddd;
            transition: all 0.3s;
        }

        #checkoutModal .form-control:focus {
            border-color: #4caf50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
        }

        #checkoutModal .btn-success {
            background-color: #4caf50;
            border-color: #4caf50;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s;
        }

        #checkoutModal .btn-success:hover:not(:disabled) {
            background-color: #43a047;
            border-color: #43a047;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(76, 175, 80, 0.3);
        }

        #checkoutModal .btn-success:disabled {
            background-color: #a5d6a7;
            border-color: #a5d6a7;
        }

        #checkoutModal .btn-outline-secondary {
            color: #555;
            border-color: #ddd;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s;
        }

        #checkoutModal .btn-outline-secondary:hover {
            background-color: #f5f5f5;
            color: #333;
        }

        #map {
            border: 2px solid #e8f5e9;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }

        #map:hover {
            box-shadow: 0 6px 15px rgba(76, 175, 80, 0.2);
        }

        #selectedAddress {
            color: #4caf50;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .location-confirm-btn {
            margin-top: 10px;
            width: 100%;
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 0;
            font-weight: 500;
            cursor: pointer;
        }
    </style>
</head>
<body>
<!-- Notification Container -->
<div id="notification-container"></div>

<header class="navbar navbar-expand-lg p-3" style="position: fixed; top: 0; left: 0; width: 100%; background-color: white; color: white; padding: 5px 8px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); z-index: 1000;">
    <div class="d-flex align-items-center me-2">
        <img src="images/logo/img.png" alt="not found !" style="width: 110px; margin-left: 10px; margin-right: 95px;">
        <a class="navbar-brand" href="store.html" style="text-decoration: none; cursor: default; font-size: 24px;"></a>
    </div>

    <div class="d-flex align-items-center me-auto me-4">
        <a class="navbar-brand" style="color: #6c757d; font-weight: bolder; font-size: 17px" href="store.html">HOME</a>
        <a class="navbar-brand" style="color: #6c757d; font-weight: bolder; font-size: 17px" href="contact.html">CONTACT</a>
        <a class="navbar-brand" style="color: #6c757d; font-weight: bolder; font-size: 17px" href="about.html">ABOUT US</a>
        <a class="navbar-brand admin-page" href="adminpage.html" style="display: none; font-weight: bolder; color: #6c757d; font-size: 17px;">Admin page</a>
    </div>

    <div class="d-flex align-items-center">
        <div class="cart-icons d-flex align-items-center">
            <a href="#"><i class="bi bi-cart"></i><span style="color: #28a745">Basket</span><span class="cart-badge" id="cartSize"></span></a>
            <a href="orders.html"><i class="bi bi-box-seam"></i><span>Orders</span></a>
        </div>

        <!-- User Profile Dropdown -->
        <div class="dropdown ms-3" id="userProfile" style="display: none;">
            <button class="btn btn-outline-success dropdown-toggle d-flex align-items-center" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-person-circle me-2"></i>
                <span id="usernameDisplay"></span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                <li><a class="profile" href="profile.html"><i class="bi bi-person"></i> Profile</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="profile text-danger" href="#" id="logoutBtn"><i class="bi bi-box-arrow-right"></i> Logout</a></li>
            </ul>
        </div>

        <button id="authButton" class="btn btn-outline-success ms-3"></button>
    </div>
</header>

<div class="cart-container">
    <div id="basketDetails"></div>

    <div class="checkout-container">
        <div id="showtotalcost"></div>

        <div class="buttons-row">
            <button type="button" onclick="clearCart()" class="clear-cart-button">
                <i class="fas fa-trash-alt" style="color:red"></i>
                <span> Clear Cart</span>
            </button>

            <button onclick="createOrder()" id="checkoutBtn" class="checkout-button">
                Proceed to Checkout
            </button>
        </div>
    </div>
</div>

<footer class="footer">
    <div class="containerjon">
        <div class="footer-section">
            <h2>Our Company</h2>
            <div class="underline"></div>
            <p>The one-stop destination for amazing products and services. Connect with us and stay updated on our latest offers and exclusive discounts.</p>
            <div class="social-icons">
                <a href="#"><i class="fab fa-facebook"></i></a>
                <a href="#"><i class="fab fa-twitter"></i></a>
                <a href="#"><i class="fab fa-instagram"></i></a>
                <a href="#"><i class="fab fa-linkedin"></i></a>
            </div>
        </div>

        <div class="footer-section">
            <h2>Quick Links</h2>
            <div class="underline"></div>
            <ul>
                <li><a href="store.html">Home</a></li>
                <li><a href="#">Categories</a></li>
                <li><a href="contact.html">Contact</a></li>
                <li><a href="inquiry.html">Inquiry</a></li>
            </ul>
        </div>

        <div class="footer-section">
            <h2>Stay Connected</h2>
            <div class="underline"></div>
            <input type="email" placeholder="Enter your phone number..." class="email-input">
            <button class="subscribe-btn">Subscribe</button>
        </div>
    </div>
</footer>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="js/request.js"></script>

<script>
    // Checkout Modal with Yandex Maps Integration
    let map;
    let placemark;
    let selectedLocation = {
        latitude: null,
        longitude: null,
        address: ""
    };

    function initCheckoutModal() {
        // Create modal HTML if it doesn't exist
        if (!document.getElementById("checkoutModal")) {
            const modalHTML = `
        <div class="modal fade" id="checkoutModal" tabindex="-1" aria-labelledby="checkoutModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-md">
                <div class="modal-content">
                    <div class="modal-header" style="background: linear-gradient(135deg, #4CAF50, #2E7D32); color: white;">
                        <h5 class="modal-title" id="checkoutModalLabel">Complete Your Order</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle-fill me-2"></i>
                                    Please select your delivery location on the map and provide your phone number
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-geo-alt-fill text-success me-2"></i>Delivery Location
                                </label>
                                <div id="map" style="width: 100%; height: 200px; border-radius: 10px;"></div>
                                <div id="selectedAddress" class="mt-2 text-muted fst-italic"></div>
                                <button type="button" id="confirmLocationBtn" class="location-confirm-btn">
                                    <i class="bi bi-check-circle me-2"></i>Confirm This Location
                                </button>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="bi bi-telephone-fill text-success me-2"></i>Phone Number
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">+998</span>
                                        <input type="tel" class="form-control" id="phoneNumber" placeholder="90 123 45 67" maxlength="12">
                                    </div>
                                    <div class="form-text">Format: 90 123 45 67</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="bi bi-card-text text-success me-2"></i>Additional Notes (Optional)
                                    </label>
                                    <textarea class="form-control" id="orderNotes" rows="3" placeholder="Any special instructions for delivery"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-2"></i>Cancel
                        </button>
                        <button type="button" class="btn btn-success" id="confirmOrderBtn" disabled>
                            <i class="bi bi-check-circle me-2"></i>Confirm Order
                        </button>
                    </div>
                </div>
            </div>
        </div>`;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Initialize phone number formatting
        const phoneInput = document.getElementById('phoneNumber');
        phoneInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 0) {
                if (value.length <= 2) {
                    value = value;
                } else if (value.length <= 5) {
                    value = value.slice(0, 2) + ' ' + value.slice(2);
                } else if (value.length <= 7) {
                    value = value.slice(0, 2) + ' ' + value.slice(2, 5) + ' ' + value.slice(5);
                } else {
                    value = value.slice(0, 2) + ' ' + value.slice(2, 5) + ' ' + value.slice(5, 7) + ' ' + value.slice(7, 9);
                }
            }
            e.target.value = value;
            validateCheckoutForm();
        });

        // Add confirm location button handler
        document.getElementById('confirmLocationBtn').addEventListener('click', function() {
            // If we don't have coordinates yet, use the center of the map
            if (!selectedLocation.latitude || !selectedLocation.longitude) {
                const center = map.getCenter();
                selectedLocation.latitude = center[0];
                selectedLocation.longitude = center[1];

                // Get address for these coordinates
                ymaps.geocode(center).then(function(res) {
                    const firstGeoObject = res.geoObjects.get(0);
                    selectedLocation.address = firstGeoObject.getAddressLine();
                    document.getElementById('selectedAddress').textContent = `Selected address: ${selectedLocation.address}`;
                    document.getElementById('selectedAddress').style.color = '#4caf50';
                    document.getElementById('selectedAddress').style.fontWeight = 'bold';
                    validateCheckoutForm();
                });
            } else {
                // Just confirm the existing selection
                document.getElementById('selectedAddress').style.color = '#4caf50';
                document.getElementById('selectedAddress').style.fontWeight = 'bold';
            }

            // Visual feedback
            document.getElementById('confirmLocationBtn').textContent = "✓ Location Confirmed";
            document.getElementById('confirmLocationBtn').style.backgroundColor = "#43a047";

            validateCheckoutForm();
        });

        // Also validate when notes change
        document.getElementById('orderNotes').addEventListener('input', validateCheckoutForm);

        // Add event listener to confirm order button
        document.getElementById('confirmOrderBtn').addEventListener('click', submitOrder);

        // Load Yandex Maps script if not already loaded
        if (typeof ymaps === 'undefined') {
            const script = document.createElement('script');
            script.src = 'https://api-maps.yandex.ru/2.1/?apikey=your-api-key&lang=en_US';
            script.async = true;
            script.onload = initYandexMap;
            document.head.appendChild(script);
        } else {
            initYandexMap();
        }

        // Show the modal
        const checkoutModal = new bootstrap.Modal(document.getElementById('checkoutModal'));
        checkoutModal.show();
    }

    function initYandexMap() {
        ymaps.ready(() => {
            // Default coordinates (Tashkent)
            const defaultCoords = [41.311151, 69.279737];

            map = new ymaps.Map('map', {
                center: defaultCoords,
                zoom: 12,
                controls: ['zoomControl', 'geolocationControl']
            });

            // Create placemark
            placemark = new ymaps.Placemark(defaultCoords, {
                iconCaption: 'Drag to your location'
            }, {
                draggable: true
            });

            map.geoObjects.add(placemark);

            // Try to get user's location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const userCoords = [position.coords.latitude, position.coords.longitude];
                    map.setCenter(userCoords);
                    placemark.geometry.setCoordinates(userCoords);
                    getAddressFromCoords(userCoords);
                });
            }

            // Add click event to map
            map.events.add('click', (e) => {
                const coords = e.get('coords');
                placemark.geometry.setCoordinates(coords);
                getAddressFromCoords(coords);
            });

            // Add drag event to placemark
            placemark.events.add('dragend', () => {
                const coords = placemark.geometry.getCoordinates();
                getAddressFromCoords(coords);
            });
        });
    }

    function getAddressFromCoords(coords) {
        ymaps.geocode(coords).then((res) => {
            const firstGeoObject = res.geoObjects.get(0);
            const address = firstGeoObject.getAddressLine();

            selectedLocation = {
                latitude: coords[0],
                longitude: coords[1],
                address: address
            };

            document.getElementById('selectedAddress').textContent = `Selected address: ${address}`;
            document.getElementById('selectedAddress').style.color = '';
            document.getElementById('selectedAddress').style.fontWeight = '';
            document.getElementById('confirmLocationBtn').textContent = "Confirm This Location";
            document.getElementById('confirmLocationBtn').style.backgroundColor = "#4caf50";
        });
    }

    function validateCheckoutForm() {
        const phoneNumber = document.getElementById('phoneNumber').value.trim();
        const confirmBtn = document.getElementById('confirmOrderBtn');
        const confirmLocationBtn = document.getElementById('confirmLocationBtn');

        // Enable button if location is confirmed and phone number has at least 9 digits (excluding spaces)
        const phoneDigits = phoneNumber.replace(/\s/g, '');
        const locationConfirmed = confirmLocationBtn.textContent.includes("✓");

        if (locationConfirmed && phoneDigits.length >= 9) {
            confirmBtn.disabled = false;
        } else {
            confirmBtn.disabled = true;
        }
    }

    function submitOrder() {
        const phoneNumber = '+998 ' + document.getElementById('phoneNumber').value;
        const notes = document.getElementById('orderNotes').value;
        const basket = loadBasket();

        // Convert basket Map to object for API
        const basketObject = Object.fromEntries(basket);

        // Create order data object
        const orderData = {
            basket: basketObject,
            address: {
                fullAddress: selectedLocation.address,
                latitude: selectedLocation.latitude,
                longitude: selectedLocation.longitude
            },
            phoneNumber: phoneNumber,
            notes: notes
        };

        // Show loading state
        const confirmBtn = document.getElementById('confirmOrderBtn');
        const originalBtnText = confirmBtn.innerHTML;
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Processing...';

        // Send order to server
        request({
            url: '/order',
            method: 'POST',
            data: orderData
        })
            .then(response => {
                // Clear basket
                localStorage.removeItem('basketItems');

                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('checkoutModal')).hide();

                // Show success message
                showNotification('Order placed successfully! We will deliver your items soon.');

                // Redirect to orders page
                setTimeout(() => {
                    window.location.href = 'orders.html';
                }, 2000);
            })
            .catch(error => {
                console.error('Error creating order:', error);
                alert('Failed to place order. Please try again.');

                // Reset button
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = originalBtnText;
            });
    }

    function showNotification(message) {
        // Create notification container if it doesn't exist
        let container = document.getElementById('notification-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'notification-container';
            container.style.position = 'fixed';
            container.style.top = '20px';
            container.style.right = '20px';
            container.style.zIndex = '9999';
            document.body.appendChild(container);
        }

        // Create notification element
        const notification = document.createElement('div');
        notification.className = 'notification';

        // Add icon
        const icon = document.createElement('span');
        icon.className = 'icon';
        icon.innerHTML = '✅';

        // Add message
        const text = document.createElement('span');
        text.innerText = message;

        // Add close button
        const closeButton = document.createElement('button');
        closeButton.className = 'close-btn';
        closeButton.innerHTML = '&times;';
        closeButton.onclick = () => notification.remove();

        // Assemble notification
        notification.appendChild(icon);
        notification.appendChild(text);
        notification.appendChild(closeButton);
        container.appendChild(notification);

        // Auto-remove after 5 seconds
        setTimeout(() => {
            notification.remove();
        }, 5000);
    }

    let showtotalcost = document.getElementById('showtotalcost');
    let basket = loadBasket();

    function loadBasket() {
        let storedBasket = localStorage.getItem("basketItems");
        return storedBasket ? new Map(Object.entries(JSON.parse(storedBasket))) : new Map();
    }

    function gotoMarket() {
        window.location.href = "store.html";
    }

    function clearCart() {
        localStorage.removeItem("basketItems");
        basket.clear();
        showBasketProducts();
        calculateTotalCost();
    }

    showBasketProducts();

    function showBasketProducts() {
        let productElement = document.getElementById('basketDetails');
        let checkoutContainer = document.querySelector('.checkout-container');
        productElement.innerHTML = '';
        let totalCost = 0;

        if (basket.size === 0) {
            productElement.innerHTML = `
            <div class="empty-cart">
            <div class="text-center mt-5">
               <img src="https://cdn-icons-png.flaticon.com/512/2038/2038854.png" alt="Empty Cart">
                <h4 class="text-success mt-3">Your cart is empty</h4>
                <p>Add some products to your cart to see them here.</p>
            </div>
            </div>
        `;
            checkoutContainer.classList.add('hidden');
            return;
        }

        checkoutContainer.classList.remove('hidden');

        basket.forEach((count, productId) => {
            request({
                url:'/product/each/' + productId,
                method: 'GET'
            }).then((res) => {
                const product = res.data;
                totalCost += product.price * count;
                displayProductDetails(product, count);
                updateTotalCostDisplay(totalCost);
            });
        });
    }

    function displayProductDetails(product, count) {
        let productElement = document.getElementById('basketDetails');
        productElement.innerHTML += `
        <div class="cart-item" id="cart-${product.id}">
            <span class="delete-icon" onclick="removeFromCart('${product.id}')">
                <i class="fas fa-trash"></i>
            </span>
            <img src="http://localhost:8080/api/file/${product.attachment.id}" alt="Product Image">
            <div class="details">
                <p class="fw-bold">${product.name}</p>
                <p class="price-display">${product.price}$</p>
            </div>
            <div class="quantity-controls">
                <button onclick="updateCount('${product.id}', -1)">-</button>
                <span class="quantity-value">${count}</span>
                <button onclick="updateCount('${product.id}', 1)">+</button>
            </div>
        </div>
    `;
    }

    function updateCount(productId, change) {
        if (basket.has(productId)) {
            let newCount = basket.get(productId) + change;
            if (newCount <= 0) {
                removeFromCart(productId);
            } else {
                basket.set(productId, newCount);
                saveBasket();
                document.querySelector(`#cart-${productId} .quantity-value`).textContent = newCount;
            }
            calculateTotalCost();
        }
    }

    function saveBasket() {
        localStorage.setItem("basketItems", JSON.stringify(Object.fromEntries(basket)));
    }

    function removeFromCart(productId) {
        basket.delete(productId);
        saveBasket();
        showBasketProducts();
        calculateTotalCost();
    }

    function calculateTotalCost() {
        let totalCost = 0;
        basket.forEach((count, productId) => {
            request({
                url:'/product/each/' + productId,
                method: 'GET'
            })
                .then((res) => {
                    totalCost += res.data.price * count;
                    updateTotalCostDisplay(totalCost);
                });
        });
    }

    function updateTotalCostDisplay(totalCost) {
        showtotalcost.innerHTML = `<h4>Subtotal: <span class="text-success">${totalCost.toFixed(2)}$</span></h4>`;
    }

    function createOrder() {
        let token = localStorage.getItem("token");
        if (token) {
            // Initialize checkout modal with map and phone input
            initCheckoutModal();
        } else {
            window.location.href = "login.html";  // Redirect if no token
        }
    }

    function checkUserAuth() {
        let token = localStorage.getItem("token");
        let authButton = document.getElementById("authButton");
        let userProfile = document.getElementById("userProfile");
        let usernameDisplay = document.getElementById("usernameDisplay");
        let logoutBtn = document.getElementById("logoutBtn");
        let adminPageLink = document.querySelector(".admin-page");

        if (token) {
            const decodedToken = jwt_decode(token);
            const username = decodedToken.sub || "User";
            const roles = decodedToken.roles || [];

            usernameDisplay.innerText = username;
            userProfile.style.display = "block";
            authButton.style.display = "none";

            if (roles.includes("ADMIN")) {
                adminPageLink.style.display = "block";
            } else {
                adminPageLink.style.display = "none";
            }

            logoutBtn.onclick = function () {
                localStorage.removeItem("token");
                window.location.reload();
            };
        } else {
            userProfile.style.display = "none";
            adminPageLink.style.display = "none";
            authButton.innerText = "Login";
            authButton.onclick = function () {
                window.location.href = "login.html";
            };
            authButton.style.display = "block";
        }
    }

    checkUserAuth();
</script>
</body>
</html>

